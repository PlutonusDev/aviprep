generator client {
    provider    = "prisma-client-js"
    engineType  = "binary"
}

datasource db {
    provider    = "mongodb"
    url         = env("DATABASE_URL")
}

model User {
  id                    String    @id @default(auto()) @map("_id") @db.ObjectId
  email                 String    @unique
  passwordHash          String
  arn                   String    @unique // Aviation Reference Number
  firstName             String
  lastName              String
  phone                 String    // Australian phone number format
  stripeCustomerId      String?   @unique // Stripe customer ID for payments
  isAdmin               Boolean   @default(false)
  profilePicture        String?   // URL to profile picture
  isSuspendedFromForum  Boolean   @default(false) // Forum posting suspension
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Subscription status
  hasBundle         Boolean   @default(false)
  bundleExpiry      DateTime?

  flightSchoolId      String?       @db.ObjectId
  flightSchool        FlightSchool? @relation ("FlightSchoolStudents", fields: [flightSchoolId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  isFlightSchoolAdmin Boolean       @default(false)
  managedSchool       FlightSchool? @relation ("FlightSchoolAdmin")
  enrolledAt          DateTime?
  
  // Relations
  purchases         Purchase[]
  examAttempts      ExamAttempt[]
  weakPoints        WeakPoint[]
  studySessions     StudySession[]

  // Forum relations
  threads           Thread[]  @relation("ThreadAuthor")
  posts             Post[]    @relation("PostAuthor")
  reactions         Reaction[]
  messagesSent      PrivateMessage[] @relation("MessagesSent")
  messagesReceived  PrivateMessage[] @relation("MessagesReceived")
}

model FlightSchool {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  slug          String    @unique
  email         String    @unique
  phone         String?
  address       String?
  city          String?
  state         String?
  postcode      String?
  website       String?
  logo          String?

  adminId       String    @unique @db.ObjectId
  admin         User      @relation("FlightSchoolAdmin", fields: [adminId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  isActive      Boolean   @default(true)
  maxStudents   Int       @default(50)

  apiKey        String?   @unique
  apiEnabled    Boolean   @default(true)
  webhookUrl    String?
  webhookSecret String?

  subscriptionTier    String  @default("basic")
  subscriptionExpiry  DateTime?

  students      User[]    @relation("FlightSchoolStudents")

  studentGroups StudentGroup[]

  schoolPurchases SchoolPurchase[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model StudentGroup {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  color       String    @default("#3b82f6")

  flightSchoolId  String  @db.ObjectId
  flightSchool    FlightSchool @relation(fields: [flightSchoolId], references: [id], onDelete: Cascade)

  studentIds  String[]  @db.ObjectId

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([flightSchoolId])
}

model SchoolPurchase {
  id        String    @id @default(auto()) @map("_id")  @db.ObjectId

  flightSchoolId  String  @db.ObjectId
  flightSchool    FlightSchool  @relation(fields: [flightSchoolId], references: [id], onDelete: Cascade)

  licenseType     String
  productType     String
  subjectId       String?
  tier            String

  totalSeats      Int
  usedSeats       Int   @default(0)

  pricePerSeat    Int
  totalPrice      Int

  purchasedAt     DateTime  @default(now())
  expiresAt       DateTime

  stripePaymentId String?

  @@index([flightSchoolId])
}

model Purchase {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subjectId    String   // e.g., "aero", "met", "nav"
  subjectName  String
  subjectCode  String
  
  purchaseType String   // "individual" or "bundle"
  priceAud     Int      // Price in cents
  
  // Add-ons for individual purchases
  hasPrinting  Boolean  @default(false)
  hasAiInsights Boolean @default(false)
  
  purchasedAt  DateTime @default(now())
  expiresAt    DateTime
  
  // Stripe payment reference
  stripePaymentId String?
  stripeCustomerId String?
  
  @@unique([userId, subjectId])
  @@index([userId])
  @@index([subjectId])
}

model ExamAttempt {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subjectId       String
  subjectName     String
  
  score           Int      // Percentage
  totalQuestions  Int
  correctAnswers  Int
  timeSpentMins   Int
  passed          Boolean
  
  // Detailed results stored as JSON
  questionResults Json     // Array of { questionId, answeredCorrectly, timeTaken }
  
  completedAt     DateTime @default(now())
  
  @@index([userId])
  @@index([subjectId])
  @@index([completedAt])
}

model WeakPoint {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  userId             String   @db.ObjectId
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  topic              String
  subjectId          String
  subjectName        String
  
  accuracy           Int      // Percentage
  questionsAttempted Int
  recommendation     String
  priority           String   // "high", "medium", "low"
  
  updatedAt          DateTime @updatedAt
  
  @@unique([userId, topic, subjectId])
  @@index([userId])
}

model StudySession {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subjectId   String?
  durationMins Int
  
  startedAt   DateTime
  endedAt     DateTime
  
  @@index([userId])
  @@index([startedAt])
}

model Subject {
  id              String @id @default(auto()) @map("_id") @db.ObjectId
  subjectId       String @unique // "aero", "met", etc.
  name            String
  code            String
  description     String
  totalQuestions  Int
  icon            String
  priceAud        Int    // Price in cents
}

model Question {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  subjectId    String
  topic        String
  difficulty   String // "easy", "medium", "hard"
  
  questionText String
  options      String[] // Array of options
  correctIndex Int
  explanation  String
  reference    String
  
  @@index([subjectId])
  @@index([topic])
}

model Waitlist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  createdAt DateTime @default(now())
}

model RtoContact {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  email        String
  phone        String?
  organisation String
  contacted    Boolean  @default(false) // Track if partnerships team has followed up
  notes        String?  // For internal notes
  createdAt    DateTime @default(now())
  
  @@index([email])
  @@index([createdAt])
}

model Coupon {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  code            String    @unique
  discountPercent Int       // Percentage off (0-100)
  maxUses         Int?      // Null = unlimited
  usedCount       Int       @default(0)
  validFrom       DateTime  @default(now())
  validUntil      DateTime?
  isActive        Boolean   @default(true)
  
  // Optional: restrict to specific products
  applicableProducts String[] // Product IDs it can be applied to, empty = all
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model ForumCategory {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  slug        String   @unique
  order       Int      @default(0)
  
  forums      Forum[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Forum {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  slug        String   @unique
  order       Int      @default(0)
  
  categoryId  String   @db.ObjectId
  category    ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  threads     Thread[]
  protected   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([categoryId])
}

model Thread {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  slug        String   @unique
  
  forumId     String   @db.ObjectId
  forum       Forum    @relation(fields: [forumId], references: [id], onDelete: Cascade)
  
  authorId    String   @db.ObjectId
  author      User     @relation("ThreadAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  isSticky    Boolean  @default(false)
  isClosed    Boolean  @default(false)
  viewCount   Int      @default(0)
  deleted     Boolean  @default(false)
  
  posts       Post[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([forumId, slug])
  @@index([forumId])
  @@index([authorId])
  @@index([createdAt])
}

model Post {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  content     String
  
  threadId    String   @db.ObjectId
  thread      Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  
  authorId    String   @db.ObjectId
  author      User     @relation("PostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  replyToId   String?  @db.ObjectId
  replyTo     Post?    @relation("PostReplies", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies     Post[]   @relation("PostReplies")
  
  isFirstPost Boolean  @default(false) // The opening post of a thread
  editedAt    DateTime? // Track when posts are edited
  deleted     Boolean  @default(false)
  reactions   Reaction[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([threadId])
  @@index([authorId])
}

model Reaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  type      String   // "heart", "thumbsup", "fire", "sparkles"
  
  postId    String   @db.ObjectId
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([postId, userId, type])
  @@index([postId])
  @@index([userId])
}

model PrivateMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  content     String
  
  senderId    String   @db.ObjectId
  sender      User     @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId  String   @db.ObjectId
  receiver    User     @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  
  isRead      Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}